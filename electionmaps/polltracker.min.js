/*! principalfish 23-03-2017 */
function getData(){$.when($.getJSON("polltracker/polls.json",function(a){$.each(a.polls,function(a,b){date=new Date(b.date[2],b.date[1]-1,b.date[0]),$.each(pollData,function(a){companies.indexOf(b.company)==-1&&companies.push(b.company),pollData[a].push({company:b.company,date:date,percentage:parseInt(b[a])})})}),$.each(pollData,function(a,b){b.reverse()})})).then(function(){pageLoad()})}function pageLoad(){var a=0;$.each(pollData,function(b,c){$.each(c,function(b){c[b].percentage>a&&(a=c[b].percentage)})}),a=10*Math.ceil(a/10),$.each(pollData,function(b,c){for(var d=[],e=[],f=0;f<c.length;f++)if(companies.indexOf(c[f].company)!=-1){d.push(c[f].percentage),d.length>12&&d.splice(0,1);var g=0;for(percentage in d)g+=parseInt(d[percentage]);var h=g/d.length;c[f].moving=h,e.push(c[f])}plot.draw(e,b,a)}),plot.drawAxes()}var filter={company:function(a){if(companies.indexOf(a)==-1)companies.push(a);else{var b=companies.indexOf(a);companies.splice(b,1)}$("#plot g").empty(),pageLoad()}},plot={draw:function(a,b,c){x.domain([new Date(2015,4,1),Date.now()]),y.domain([0,c]),svg.append("path").data([a]).attr("class","line "+b).attr("d",valueline),svg.selectAll("dot").data(a).enter().append("circle").attr("r",1).attr("cx",function(a){return x(a.date)}).attr("cy",function(a){return y(a.percentage)}).attr("class",b).append("svg:title").text(function(a){return a.company+" "+a.date.getDate()+"/"+(a.date.getMonth()+1)+"/"+a.date.getFullYear()+" : "+a.percentage+"%"})},drawAxes:function(){var a=new Date(2015,5,1).getTime(),b=Date.now(),c=Math.floor((b-a)/2628e6);svg.append("g").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x).ticks(c).tickFormat(timeFormat)).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),svg.append("g").call(d3.axisLeft(y)),svg.append("text").attr("transform","translate("+width/2+" ,"+(height+margin.top+25)+")").style("text-anchor","middle").text("Date"),svg.append("text").attr("transform","rotate(-90)").attr("y",0-margin.left).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("Percentage")}},margin={top:20,right:20,bottom:60,left:40},width=1e3-margin.left-margin.right,height=800-margin.top-margin.bottom,parseTime=d3.timeParse("%d-%b-%y"),x=d3.scaleTime().range([0,width]),y=d3.scaleLinear().range([height,0]),timeFormat=d3.timeFormat("%b %y"),valueline=d3.line().x(function(a){return x(a.date)}).y(function(a){return y(a.moving)}),pollData={labour:[],conservative:[],libdems:[],snp:[],green:[],ukip:[],others:[]},companies=[];$(document).ready(function(){getData()});